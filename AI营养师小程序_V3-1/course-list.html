<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>课程列表</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #F2F2F2; }
        .status-bar { height: 44px; background: #181818; color: white; display:flex; justify-content:space-between; align-items:center; padding:0 20px; font-size:14px; font-weight:600; }
        .card { background:#fff; border-radius: 16px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); border: 1px solid #E5E5E7; }
        .section-title { color:#1C1C1E; font-size: 22px; font-weight: 700; }
        .course-item { transition: transform .15s ease, box-shadow .15s ease; }
        .course-item:active { transform: scale(0.98); }
        .filter { display:flex; gap:8px; overflow-x:auto; -webkit-overflow-scrolling:touch; padding-bottom: 8px; }
        .filter::-webkit-scrollbar { display:none; }
        .tag { white-space:nowrap; padding:6px 12px; border-radius:9999px; background:#fff; border:1px solid #e5e7eb; color:#4b5563; font-size:12px; }
        .tag.active { background:#181818; color:#fff; border-color:#181818; }
        .search-input { background:#fff; border:1px solid #e5e7eb; border-radius: 12px; padding: 10px 12px; font-size: 14px; width:100%; }
        .toolbar { display:flex; gap:10px; align-items:center; }
        select.sort { background:#fff; border:1px solid #e5e7eb; border-radius: 12px; padding: 10px 12px; font-size: 14px; color:#374151; }
        .load-more { display:block; width:100%; padding:10px 0; background:#fff; border:1px solid #e5e7eb; border-radius:12px; color:#4b5563; }
    </style>
    <style>
        .back-btn { transition: all .2s ease; }
        .back-btn:active { transform: scale(0.95); }
    </style>
</head>
<body>
    <div class="status-bar">
        <div>16:41</div><div></div>
        <div class="flex items-center gap-1"><span>ll</span><span>5G</span><i class="fas fa-battery-three-quarters"></i></div>
    </div>

    <div class="px-4 pb-10">
        <!-- 头部 -->
        <div class="flex items-center py-4">
            <button class="back-btn w-10 h-10 rounded-full bg-white shadow-sm flex items-center justify-center mr-3" data-back data-fallback="community-simple.html">
                <i class="fas fa-arrow-left text-gray-600"></i>
            </button>
            <h1 class="section-title">课程列表</h1>
        </div>

        <!-- 工具栏：搜索 + 排序 -->
        <div class="toolbar mb-3">
            <input id="searchInput" class="search-input flex-1" type="search" placeholder="搜索课程名称" />
            <select id="sortSelect" class="sort">
                <option value="hot">最热</option>
                <option value="duration">时长</option>
                <option value="title">名称</option>
            </select>
        </div>

        <!-- 筛选标签（多选） -->
        <div class="filter mb-3" id="tagBar">
            <button class="tag active" data-tag="全部">全部</button>
            <button class="tag" data-tag="营养">营养</button>
            <button class="tag" data-tag="运动">运动</button>
            <button class="tag" data-tag="身心">身心</button>
            <button class="tag" data-tag="跑步">跑步</button>
        </div>

        <!-- 列表（动态渲染） -->
        <div id="courseList" class="space-y-3"></div>
        <!-- 骨架屏 -->
        <div id="skeleton" class="space-y-3">
            <div class="card p-4 flex gap-3 animate-pulse">
                <div class="w-20 h-20 rounded-xl bg-gray-200"></div>
                <div class="flex-1 min-w-0 space-y-2">
                    <div class="h-4 bg-gray-200 rounded w-2/3"></div>
                    <div class="h-3 bg-gray-100 rounded w-1/3"></div>
                </div>
                <div class="w-8 h-8 bg-gray-100 rounded"></div>
            </div>
            <div class="card p-4 flex gap-3 animate-pulse">
                <div class="w-20 h-20 rounded-xl bg-gray-200"></div>
                <div class="flex-1 min-w-0 space-y-2">
                    <div class="h-4 bg-gray-200 rounded w-2/3"></div>
                    <div class="h-3 bg-gray-100 rounded w-1/3"></div>
                </div>
                <div class="w-8 h-8 bg-gray-100 rounded"></div>
            </div>
        </div>
        <div class="mt-3"><button id="loadMoreBtn" class="load-more">加载更多</button></div>
    </div>

    <script src="common-nav.js"></script>
    <script>
        const PAGE_SIZE = 5;
        let allCourses = [];
        let working = [];
        let selectedTags = new Set();
        let searchKeyword = '';
        let sortKey = 'hot';
        let renderCount = 0;

        const listEl = document.getElementById('courseList');
        const loadMoreBtn = document.getElementById('loadMoreBtn');

        async function loadCourses(){
            try {
                const res = await fetch('courses.json', { cache: 'no-store' });
                allCourses = await res.json();
            } catch (e) {
                allCourses = [];
            }
            applyFilterSort(true);
            // 隐藏骨架
            const sk = document.getElementById('skeleton'); if (sk) sk.style.display = 'none';
        }

        function applyFilterSort(resetRender){
            const kw = searchKeyword.trim();
            const hasTagFilter = selectedTags.size > 0;
            working = allCourses.filter(c => {
                const matchKw = kw === '' || c.title.toLowerCase().includes(kw.toLowerCase());
                const matchTag = !hasTagFilter || c.tags.some(t => selectedTags.has(t));
                return matchKw && matchTag;
            });
            working.sort((a,b) => {
                if (sortKey === 'hot') return (b.learners||0) - (a.learners||0);
                if (sortKey === 'duration') return (a.durationMin||0) - (b.durationMin||0);
                return String(a.title).localeCompare(String(b.title));
            });
            if (resetRender) { renderCount = 0; listEl.innerHTML=''; }
            renderNext();
        }

        function createItemHTML(c){
            const info = `${c.durationMin}分钟 · ${(c.learners/1000).toFixed(1)}k人学习`;
            return `
            <div class="course-item card p-4 flex gap-3" data-id="${c.id}" data-link="course-detail.html?id=${c.id}" data-return="course-list.html">
                <img src="${c.cover}" alt="${c.title}" class="w-20 h-20 rounded-xl object-cover">
                <div class="flex-1 min-w-0">
                    <div class="font-bold text-gray-800">${c.title}</div>
                    <div class="text-xs text-gray-500 mt-1">${info}</div>
                </div>
                <div class="text-right text-xs text-gray-500 flex flex-col items-end justify-between">
                    <span>${(c.rating||0).toFixed(1)}分</span>
                    <i class="fas fa-chevron-right"></i>
                </div>
            </div>`;
        }

        function bindNavForNewItems(){
            listEl.querySelectorAll('[data-link]').forEach(el => {
                if (el.__bound) return; el.__bound = true;
                el.addEventListener('click', () => {
                    try { localStorage.setItem('returnToPage', 'course-list.html'); } catch(e){}
                    const target = el.getAttribute('data-link') || 'course-detail.html';
                    window.location.href = target;
                });
            });
        }

        function renderNext(){
            const next = working.slice(renderCount, renderCount + PAGE_SIZE);
            renderCount += next.length;
            next.forEach(c => listEl.insertAdjacentHTML('beforeend', createItemHTML(c)));
            bindNavForNewItems();
            loadMoreBtn.style.display = renderCount < working.length ? 'block' : 'none';
            if (working.length === 0) {
                listEl.innerHTML = '<div class="text-center text-sm text-gray-500 py-6">没有匹配的课程</div>';
            }
        }

        // 事件绑定
        document.getElementById('searchInput').addEventListener('input', (e)=>{ searchKeyword = e.target.value; applyFilterSort(true); });
        document.getElementById('sortSelect').addEventListener('change', (e)=>{ sortKey = e.target.value; applyFilterSort(true); });
        loadMoreBtn.addEventListener('click', ()=> renderNext());

        // 多选标签逻辑
        document.getElementById('tagBar').addEventListener('click', (e)=>{
            const btn = e.target.closest('.tag'); if (!btn) return;
            const tag = btn.dataset.tag;
            if (tag === '全部') {
                selectedTags.clear();
                document.querySelectorAll('#tagBar .tag').forEach(t => t.classList.toggle('active', t.dataset.tag === '全部'));
            } else {
                const isActive = btn.classList.toggle('active');
                if (isActive) selectedTags.add(tag); else selectedTags.delete(tag);
                document.querySelector('#tagBar .tag[data-tag="全部"]').classList.toggle('active', selectedTags.size === 0);
            }
            applyFilterSort(true);
        });

        // 加载数据
        loadCourses();
    </script>
</body>
</html>


