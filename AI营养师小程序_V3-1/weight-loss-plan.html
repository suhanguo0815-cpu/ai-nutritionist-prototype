<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的健康方案</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #F2F2F2;
            min-height: 100vh;
        }
        
        .status-bar {
            height: 44px;
            background: #181818;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid #f0f0f0;
        }

        .phase-card {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .phase-card::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            background: #C3EB2E;
            opacity: 0.6;
        }

        .phase-card.active {
            border-color: #C3EB2E;
            background: linear-gradient(to right, white, #F9FBF0);
        }

        .phase-card.active::after {
            opacity: 1;
        }

        .diet-principle {
            transition: all 0.3s ease;
        }
        
        .diet-principle:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .progress-ring {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, #C3EB2E 0%, #C3EB2E 30%, #E5E5E7 30%, #E5E5E7 100%);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .progress-ring::before {
            content: '';
            position: absolute;
            width: 100px;
            height: 100px;
            background: white;
            border-radius: 50%;
        }
        
        .progress-content {
            position: relative;
            z-index: 1;
            text-align: center;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fadeInUp {
            animation: fadeInUp 0.6s ease-out forwards;
        }

        /* 统一的输入样式，和其他页面风格一致 */
        .input-basic {
            width: 6rem;
            padding: 8px 10px;
            border: 1px solid #e5e7eb; /* gray-200 */
            border-radius: 8px;
            background: #ffffff;
            text-align: right;
            color: #111827; /* gray-900 */
            transition: box-shadow 0.2s ease, border-color 0.2s ease;
            outline: none;
        }
        .input-basic:focus {
            border-color: #C3EB2E;
            box-shadow: 0 0 0 3px rgba(195,235,46,0.25);
        }
        .subpage-title { color: #1C1C1E; font-size: 22px; font-weight: 700; letter-spacing: 0.2px; }
        .subpage-title-inbar { color: #ffffff; font-size: 22px; font-weight: 700; letter-spacing: 0.2px; }
        .subsection-title { color: #1C1C1E; font-size: 18px; font-weight: 700; letter-spacing: 0.2px; }
    </style>
</head>
<body>
    <!-- 状态栏 -->
    <div class="status-bar">
        <div>16:41</div>
        <div class="flex items-center gap-2">
            <button class="text-white back-btn" data-back data-fallback="profile.html">
                <i class="fas fa-arrow-left"></i>
            </button>
            <span class="subpage-title-inbar">我的健康方案</span>
        </div>
        <div class="flex items-center gap-1">
            <span>ll</span>
            <span>5G</span>
            <i class="fas fa-battery-three-quarters"></i>
        </div>
    </div>

    <!-- 主内容 -->
    <div class="px-6 pb-20 pt-4">
        <!-- 目标进度 -->
        <div class="card p-6 mb-6 animate-fadeInUp">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="subsection-title">目标进度</h2>
                    <span class="text-sm text-gray-600 mt-1"></span>
                </div>
                <button class="text-sm text-gray-600 flex items-center gap-1" data-link="goal-setting.html" data-return="weight-loss-plan.html">
                    <span>调整目标</span>
                    <i class="fas fa-chevron-right text-xs"></i>
                </button>
            </div>
            
            <div class="flex items-center justify-between">
                <div class="progress-ring">
                    <div class="progress-content">
                        <div class="text-3xl font-bold text-gray-800">30%</div>
                        <div class="text-sm text-gray-600"></div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="mb-4">
                        <div class="text-sm text-gray-600">目标体重</div>
                        <div id="plan-target-weight" class="text-2xl font-bold text-gray-800">66.9kg</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-600">当前体重</div>
                        <div id="plan-current-weight" class="text-2xl font-bold text-gray-800">69.0kg</div>
                    </div>
                </div>
            </div>
        </div>


        <!-- T型餐盘饮食原则 -->
        <div class="mb-6 animate-fadeInUp" style="animation-delay: 0.4s;">
            <div class="flex items-center justify-between mb-4">
                <h2 class="subsection-title">T型餐盘饮食原则</h2>
                <div class="text-sm" style="color: #C3EB2E;">211结构</div>
            </div>
            
            <div class="space-y-4">
                <!-- 蔬菜占比 -->
                <div class="diet-principle card p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background-color: rgba(195, 235, 46, 0.1);">
                            <i class="fas fa-carrot text-lg" style="color: #C3EB2E;"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between">
                                <label for="plate-veg" class="text-base font-bold text-gray-800">蔬菜占比</label>
                                <div class="flex items-center gap-2">
                                    <input id="plate-veg" type="number" min="0" max="100" step="1" class="input-basic"/>
                                    <span class="text-gray-600">%</span>
                                </div>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">优选深色蔬菜，形成"彩虹饮食"</p>
                        </div>
                    </div>
                </div>

                <!-- 蛋白质占比 -->
                <div class="diet-principle card p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background-color: rgba(24, 24, 24, 0.1);">
                            <i class="fas fa-drumstick-bite text-lg text-gray-800"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between">
                                <label for="plate-protein" class="text-base font-bold text-gray-800">蛋白质占比</label>
                                <div class="flex items-center gap-2">
                                    <input id="plate-protein" type="number" min="0" max="100" step="1" class="input-basic"/>
                                    <span class="text-gray-600">%</span>
                                </div>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">红肉:白肉:植物蛋白=1:1:1</p>
                        </div>
                    </div>
                </div>

                <!-- 主食占比 -->
                <div class="diet-principle card p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background-color: rgba(24, 24, 24, 0.1);">
                            <i class="fas fa-bread-slice text-lg text-gray-800"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between">
                                <label for="plate-carb" class="text-base font-bold text-gray-800">主食占比</label>
                                <div class="flex items-center gap-2">
                                    <input id="plate-carb" type="number" min="0" max="100" step="1" class="input-basic"/>
                                    <span class="text-gray-600">%</span>
                                </div>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">精米面:全谷物:薯类=1:1:1</p>
                        </div>
                    </div>
                </div>
                <p class="text-xs text-gray-500 px-1">比例合计不超过 100%，若超出将自动回退当前输入。</p>
            </div>
        </div>

        <!-- 每日热量建议 -->
        <div class="card p-6 animate-fadeInUp" style="animation-delay: 0.6s;">
            <div class="flex items-center justify-between mb-4">
                <h2 class="subsection-title">热量建议</h2>
                <div class="flex items-center gap-2">
                    <input id="daily-calories" type="number" min="800" max="4000" step="10" class="input-basic" />
                    <span class="text-lg font-bold" style="color: #C3EB2E;">kcal/日</span>
                </div>
            </div>
            <p class="text-sm text-gray-600">遵循567份饱腹原则：先以蔬菜为主吃到5分饱，再以肉蛋为主吃到6分饱，最后以主食为主吃到7分饱，实现热量可控。</p>
        </div>

        <!-- 喝水建议 -->
        <div class="card p-6 mt-6 animate-fadeInUp" style="animation-delay: 0.7s;">
            <div class="flex items-center justify-between mb-4">
                <h2 class="subsection-title">喝水建议</h2>
                <div class="flex items-center gap-2">
                    <input id="water-ml" type="number" min="500" max="6000" step="50" class="input-basic" />
                    <span class="text-lg font-bold" style="color: #C3EB2E;">ml/日</span>
                </div>
            </div>
            <p class="text-sm text-gray-600">常规建议：每公斤体重大约30ml，炎热或运动天适当增加。</p>
        </div>

        <!-- 运动建议 -->
        <div class="card p-6 mt-6 animate-fadeInUp" style="animation-delay: 0.8s;">
            <div class="flex items-center justify-between mb-4">
                <h2 class="subsection-title">运动建议</h2>
                <div class="flex items-center gap-2">
                    <input id="exercise-minutes" type="number" min="10" max="180" step="5" class="input-basic" />
                    <span class="text-lg font-bold" style="color: #C3EB2E;">分钟/日</span>
                </div>
            </div>
            <p class="text-sm text-gray-600">推荐快走、骑行等中等强度有氧30分钟以上，配合每周2-3次力量训练。</p>
        </div>
    </div>
<script>
  (function(){
    const getNumber = (v) => {
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    };

    // 同步顶部当前/目标体重展示
    const cw = localStorage.getItem('currentWeight');
    const tw = localStorage.getItem('targetWeight');
    if (cw) document.getElementById('plan-current-weight').textContent = parseFloat(cw).toFixed(1) + 'kg';
    if (tw) document.getElementById('plan-target-weight').textContent = parseFloat(tw).toFixed(1) + 'kg';

    // 初始化/恢复：T型餐盘占比
    const vegInput = document.getElementById('plate-veg');
    const proteinInput = document.getElementById('plate-protein');
    const carbInput = document.getElementById('plate-carb');

    const savedVeg = getNumber(localStorage.getItem('plateVeg')) ?? 50;
    const savedProtein = getNumber(localStorage.getItem('plateProtein')) ?? 25;
    const savedCarb = getNumber(localStorage.getItem('plateCarb')) ?? 25;

    vegInput.value = savedVeg;
    proteinInput.value = savedProtein;
    carbInput.value = savedCarb;

    function clamp01to100(v){
      const n = Math.round(Number(v) || 0);
      return Math.min(100, Math.max(0, n));
    }

    function savePlate(){
      localStorage.setItem('plateVeg', String(clamp01to100(vegInput.value)));
      localStorage.setItem('plateProtein', String(clamp01to100(proteinInput.value)));
      localStorage.setItem('plateCarb', String(clamp01to100(carbInput.value)));
    }

    function adjustPlate(changed){
      // 读取并夹紧 0-100
      const currentValues = {
        veg: clamp01to100(vegInput.value),
        pro: clamp01to100(proteinInput.value),
        carb: clamp01to100(carbInput.value)
      };

      const others = ['veg','pro','carb'].filter(k => k !== changed);
      // 其他两项保持不变（同样限制在 0-100）
      const sumOthers = clamp01to100(currentValues[others[0]]) + clamp01to100(currentValues[others[1]]);
      const maxAllowedForChanged = Math.max(0, 100 - sumOthers);
      currentValues[changed] = Math.min(maxAllowedForChanged, clamp01to100(currentValues[changed]));

      // 写回输入框
      vegInput.value = currentValues.veg;
      proteinInput.value = currentValues.pro;
      carbInput.value = currentValues.carb;

      // 保存
      savePlate();
    }

    vegInput.addEventListener('blur', () => adjustPlate('veg'));
    proteinInput.addEventListener('blur', () => adjustPlate('pro'));
    carbInput.addEventListener('blur', () => adjustPlate('carb'));

    // 初始化/恢复：每日热量
    const caloriesInput = document.getElementById('daily-calories');
    const savedCal = getNumber(localStorage.getItem('dailyCalories'));
    caloriesInput.value = savedCal ?? 1551;
    caloriesInput.addEventListener('blur', function(){
      const v = clamp01to100(this.value); // reuse clamp for int then rescale bounds below
      let kc = Math.round(Number(this.value) || 0);
      if (!Number.isFinite(kc)) kc = 0;
      kc = Math.min(4000, Math.max(800, kc));
      this.value = kc;
      localStorage.setItem('dailyCalories', String(kc));
    });

    // 初始化/恢复：喝水（ml），默认=体重(kg)*30ml
    const waterInput = document.getElementById('water-ml');
    const cwNum = getNumber(cw);
    const defaultWater = cwNum ? Math.round(cwNum * 30) : 1800;
    const savedWater = getNumber(localStorage.getItem('waterMl')) ?? defaultWater;
    waterInput.value = savedWater;
    waterInput.addEventListener('blur', function(){
      let ml = Math.round(Number(this.value) || 0);
      ml = Math.min(6000, Math.max(500, ml));
      this.value = ml;
      localStorage.setItem('waterMl', String(ml));
    });

    // 初始化/恢复：运动（分钟/日）
    const sportInput = document.getElementById('exercise-minutes');
    const savedSport = getNumber(localStorage.getItem('exerciseMinutes')) ?? 30;
    sportInput.value = savedSport;
    sportInput.addEventListener('blur', function(){
      let m = Math.round(Number(this.value) || 0);
      m = Math.min(180, Math.max(10, m));
      this.value = m;
      localStorage.setItem('exerciseMinutes', String(m));
    });
  })();
</script>
<script src="common-nav.js"></script>
<script>
  // 离开前兜底保存：将当前输入值再写入一次，避免仅依赖 blur
  (function(){
    function clamp(n, min, max){ n = Math.round(Number(n)||0); return Math.min(max, Math.max(min, n)); }
    function savePlateIfAny(){
      const v = document.getElementById('plate-veg');
      const p = document.getElementById('plate-protein');
      const c = document.getElementById('plate-carb');
      if (v && p && c){
        try {
          localStorage.setItem('plateVeg', String(clamp(v.value, 0, 100)));
          localStorage.setItem('plateProtein', String(clamp(p.value, 0, 100)));
          localStorage.setItem('plateCarb', String(clamp(c.value, 0, 100)));
        } catch(e){}
      }
    }
    function saveNumbers(){
      const cal = document.getElementById('daily-calories');
      const water = document.getElementById('water-ml');
      const sport = document.getElementById('exercise-minutes');
      if (cal){ let kc = Math.round(Number(cal.value)||0); kc = Math.min(4000, Math.max(800, kc)); try { localStorage.setItem('dailyCalories', String(kc)); } catch(e){} }
      if (water){ let ml = Math.round(Number(water.value)||0); ml = Math.min(6000, Math.max(500, ml)); try { localStorage.setItem('waterMl', String(ml)); } catch(e){} }
      if (sport){ let m = Math.round(Number(sport.value)||0); m = Math.min(180, Math.max(10, m)); try { localStorage.setItem('exerciseMinutes', String(m)); } catch(e){} }
    }
    window.addEventListener('pagehide', function(){ savePlateIfAny(); saveNumbers(); });
    window.addEventListener('beforeunload', function(){ savePlateIfAny(); saveNumbers(); });
  })();
</script>
</body>
</html>